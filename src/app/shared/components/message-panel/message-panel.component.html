<!-- Message Panel -->
@if (isOpen()) {
  <div class="fixed inset-0 bg-black/50 flex justify-end items-start z-[1000] animate-fade-in" (click)="onClose()">
    <div class="w-full max-w-[420px] h-full bg-white rounded-l-3xl shadow-[-4px_0_20px_rgba(0,0,0,0.15)] flex flex-col animate-slide-in" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200">
        <div class="flex items-center gap-4">
          <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-700 m-0">
            <!-- <app-icon name="chat-bubble" size="sm" /> -->
            Messages
          </h3>
          @if (getUnreadCount() > 0) {
            <span class="bg-[#e76500] text-white px-3 py-1 rounded-full text-xs font-medium">
              {{ getUnreadCount() }}
            </span>
          }
        </div>
        <button class="bg-transparent border-0 p-2 rounded-md text-gray-500 cursor-pointer transition-all hover:bg-gray-100 hover:text-gray-700" (click)="onClose()" aria-label="Close message panel">
          <app-icon name="close" size="sm" />
        </button>
      </div>

      <!-- Messages List -->
      <div class="flex-1 overflow-y-auto p-4">
        @if (defaultMessages().length > 0) {
          <div class="flex flex-col gap-3">
            @for (message of defaultMessages(); track message.id) {
              <div 
                class="bg-white border border-gray-200 rounded-xl p-4 transition-all hover:border-gray-300 hover:shadow-sm cursor-pointer
                {{ !message.read ? 'bg-[#FFFCEC] border-[#E76500]' : '' }}"
                (click)="onMessageClick(message)"
              >
                <!-- Item Header with Icon and Arrow -->
                <div class="flex items-center gap-3">
                  <!-- Avatar -->
                  
                  <!-- Content -->
                  <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">

                        <h4 class="text-base font-semibold text-gray-700 m-0 flex gap-2 justify-between items-center">
                         
                          <div>
                            <app-avatar [name]="message.sender" size="xs" />
                            <span>{{ message.tripID }}</span>
                          </div>
                           <div class="flex justify-between items-center mt-2">
                          <span class="text-xs font-medium px-2 py-1 rounded-full
                            {{ !message.read ? 'bg-[#e76500] text-white' : 'bg-gray-100 text-gray-600' }}">
                            {{ !message.read ? 'Unread' : 'Read' }}
                          </span>
                        </div>
                        </h4>
                        <p class="m-0 text-gray-600 text-sm leading-relaxed overflow-hidden text-ellipsis 
                          {{ isMessageExpanded(message) ? '' : 'line-clamp-2' }}"
                          (click)="toggleMessageExpansion(message); $event.stopPropagation()">
                          {{ message.content }}
                        </p>
                          <span class="text-xs text-gray-400">{{ message.time }}</span>
                       
                      </div>
                      
                      <!-- Arrow Icon -->
                      <div class="flex-shrink-0 ml-2 transition-transform {{ isMessageExpanded(message) ? 'rotate-90' : '' }}">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_39308_39114)">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.14689 4.14604C9.19334 4.09948 9.24852 4.06253 9.30926 4.03733C9.37001 4.01212 9.43513 3.99915 9.50089 3.99915C9.56666 3.99915 9.63178 4.01212 9.69253 4.03733C9.75327 4.06253 9.80845 4.09948 9.85489 4.14604L17.1779 11.47C17.3183 11.6107 17.3972 11.8013 17.3972 12C17.3972 12.1988 17.3183 12.3894 17.1779 12.53L9.85489 19.854C9.76101 19.9479 9.63367 20.0007 9.50089 20.0007C9.36812 20.0007 9.24078 19.9479 9.14689 19.854C9.05301 19.7602 9.00026 19.6328 9.00026 19.5C9.00026 19.3673 9.05301 19.2399 9.14689 19.146L16.2939 12L9.14689 4.85404C9.10033 4.80759 9.06339 4.19248 9.03818 4.69167C9.01297 4.63093 9 4.56581 9 4.50004C9 4.43427 9.01297 4.36915 9.03818 4.30841C9.06339 4.24766 9.10033 4.19248 9.14689 4.14604Z" fill="#5A6474"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_39308_39114">
                        <rect width="24" height="24" fill="white"/>
                        </clipPath>
                        </defs>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-12 px-4 text-gray-600">
            <app-icon name="chat-bubble" size="lg" class="text-gray-300 mb-4" />
            <h4 class="text-lg font-semibold text-gray-700 m-0 mb-2">No messages</h4>
            <p class="m-0 text-sm">You don't have any messages at the moment.</p>
          </div>
        }
      </div>

      
    </div>
  </div>
}
